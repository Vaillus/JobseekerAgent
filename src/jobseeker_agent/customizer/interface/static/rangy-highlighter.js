!function(e,t){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(t.rangy)}(function(e){return e.createModule("Highlighter",["ClassApplier"],function(y,e){var t=y.dom,i=t.arrayContains,o=t.getBody,E=y.util.createOptions,T=y.util.forEach,s=1;function n(e,t){return e.characterRange.start-t.characterRange.start}function l(e,t){return t?e.getElementById(t):o(e)}var r={};function a(e,t){this.type=e,this.converterCreator=t}function h(e,t){r[e]=new a(e,t)}function u(e){var t=r[e];if(t instanceof a)return t.create();throw new Error("Highlighter type '"+e+"' is not valid")}function x(e,t){this.start=e,this.end=t}a.prototype.create=function(){var e=this.converterCreator();return e.type=this.type,e},y.registerHighlighterType=h,x.prototype={intersects:function(e){return this.start<e.end&&this.end>e.start},isContiguousWith:function(e){return this.start==e.end||this.end==e.start},union:function(e){return new x(Math.min(this.start,e.start),Math.max(this.end,e.end))},intersection:function(e){return new x(Math.max(this.start,e.start),Math.min(this.end,e.end))},getComplements:function(e){var t=[];if(this.start>=e.start){if(this.end<=e.end)return[];t.push(new x(e.end,this.end))}else t.push(new x(this.start,Math.min(this.end,e.start))),this.end>e.end&&t.push(new x(e.end,this.end));return t},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},x.fromCharacterRange=function(e){return new x(e.start,e.end)};var c,g={rangeToCharacterRange:function(e,t){e=e.getBookmark(t);return new x(e.start,e.end)},characterRangeToRange:function(e,t,n){e=y.createRange(e);return e.moveToBookmark({start:t.start,end:t.end,containerNode:n}),e},serializeSelection:function(e,t){for(var n=e.getAllRanges(),r=[],i=1==n.length&&e.isBackward(),a=0,s=n.length;a<s;++a)r[a]={characterRange:this.rangeToCharacterRange(n[a],t),backward:i};return r},restoreSelection:function(e,t,n){e.removeAllRanges();for(var r,i,a=e.win.document,s=0,h=t.length;s<h;++s)(i=t[s]).characterRange,r=this.characterRangeToRange(a,i.characterRange,n),e.addRange(r,i.backward)}};function A(e,t,n,r,i,a){i?(this.id=i,s=Math.max(s,i+1)):this.id=s++,this.characterRange=t,this.doc=e,this.classApplier=n,this.converter=r,this.containerElementId=a||null,this.applied=!1}function p(e,t){t=t||"textContent",this.doc=e||document,this.classAppliers={},this.highlights=[],this.converter=u(t)}h("textContent",function(){return g}),h("TextRange",function(){if(!c){var e=y.modules.TextRange;if(!e)throw new Error("TextRange module is missing.");if(!e.supported)throw new Error("TextRange module is present but not supported.");c={rangeToCharacterRange:function(e,t){return x.fromCharacterRange(e.toCharacterRange(t))},characterRangeToRange:function(e,t,n){e=y.createRange(e);return e.selectCharacters(n,t.start,t.end),e},serializeSelection:function(e,t){return e.saveCharacterRanges(t)},restoreSelection:function(e,t,n){e.restoreCharacterRanges(n,t)}}}return c}),A.prototype={getContainerElement:function(){return l(this.doc,this.containerElementId)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(e){this.characterRange=this.converter.rangeToCharacterRange(e,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(e){return this.getRange().containsNodeContents(e.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.className+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},p.prototype={addClassApplier:function(e){this.classAppliers[e.className]=e},getHighlightForElement:function(e){for(var t=this.highlights,n=0,r=t.length;n<r;++n)if(t[n].containsElement(e))return t[n];return null},removeHighlights:function(e){for(var t,n=0,r=this.highlights.length;n<r;++n)t=this.highlights[n],i(e,t)&&(t.unapply(),this.highlights.splice(n--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(e){var n=[],r=this.highlights;return T(e,function(t){T(r,function(e){t.intersectsRange(e.getRange())&&!i(n,e)&&n.push(e)})}),n},highlightCharacterRanges:function(e,t,n){var r,i,a,s,h,o,c,g,l,u,p=this.highlights,d=this.converter,f=this.doc,R=[],m=e?this.classAppliers[e]:null,v=(n=E(n,{containerElementId:null,exclusive:!0})).containerElementId,C=n.exclusive;for(v&&(e=this.doc.getElementById(v))&&((n=y.createRange(this.doc)).selectNodeContents(e),s=new x(0,n.toString().length)),r=0,i=t.length;r<i;++r)if(h=t[r],l=[],(h=s?h.intersection(s):h).start!=h.end){for(a=0;a<p.length;++a)c=!1,v==p[a].containerElementId&&(o=p[a].characterRange,u=!(g=m==p[a].classApplier)&&C,(o.intersects(h)||o.isContiguousWith(h))&&(g||u)&&(u&&T(o.getComplements(h),function(e){l.push(new A(f,e,p[a].classApplier,d,null,v))}),c=!0,g&&(h=o.union(h)))),c?(R.push(p[a]),p[a]=new A(f,o.union(h),m,d,null,v)):l.push(p[a]);m&&l.push(new A(f,h,m,d,null,v)),this.highlights=p=l}T(R,function(e){e.unapply()});var w=[];return T(p,function(e){e.applied||(e.apply(),w.push(e))}),w},highlightRanges:function(e,t,n){var r,i=[],a=this.converter,s=(n=E(n,{containerElement:null,exclusive:!0})).containerElement,h=s?s.id:null;return s&&(r=y.createRange(s)).selectNodeContents(s),T(t,function(e){var t=s?r.intersection(e):e;i.push(a.rangeToCharacterRange(t,s||o(e.getDocument())))}),this.highlightCharacterRanges(e,i,{containerElementId:h,exclusive:n.exclusive})},highlightSelection:function(e,t){var n=this.converter,r=!!e&&this.classAppliers[e],i=(t=E(t,{containerElementId:null,exclusive:!0})).containerElementId,a=t.exclusive,t=t.selection||y.getSelection(this.doc),s=l(t.win.document,i);if(!r&&!1!==e)throw new Error("No class applier found for class '"+e+"'");var r=n.serializeSelection(t,s),h=[],e=(T(r,function(e){h.push(x.fromCharacterRange(e.characterRange))}),this.highlightCharacterRanges(e,h,{containerElementId:i,exclusive:a}));return n.restoreSelection(t,r,s),e},unhighlightSelection:function(e){e=e||y.getSelection(this.doc);var t=this.getIntersectingHighlights(e.getAllRanges());return this.removeHighlights(t),e.removeAllRanges(),t},getHighlightsInSelection:function(e){return e=e||y.getSelection(this.doc),this.getIntersectingHighlights(e.getAllRanges())},selectionOverlapsHighlight:function(e){return 0<this.getHighlightsInSelection(e).length},serialize:function(r){var e,i,a,s,h=this,t=h.highlights;return t.sort(n),e=(r=E(r,{serializeHighlightText:!1,type:h.converter.type})).type,(a=e!=h.converter.type)&&(s=u(e)),i=["type:"+e],T(t,function(e){var t=e.characterRange,n=(a&&(n=e.getContainerElement(),t=s.rangeToCharacterRange(h.converter.characterRangeToRange(h.doc,t,n),n)),[t.start,t.end,e.id,e.classApplier.className,e.containerElementId]);r.serializeHighlightText&&n.push(e.getText()),i.push(n.join("$"))}),i.join("|")},deserialize:function(e){var t,n,r,i,a,s=e.split("|"),h=[],e=s[0],o=!1;if(!e||!(t=/^type:(\w+)$/.exec(e)))throw new Error("Serialized highlights are invalid.");(e=t[1])!=this.converter.type&&(n=u(e),o=!0),s.shift();for(var c,g=s.length;0<g--;){if(r=new x(+(c=s[g].split("$"))[0],+c[1]),i=c[4]||null,o&&(a=l(this.doc,i),r=this.converter.rangeToCharacterRange(n.characterRangeToRange(this.doc,r,a),a)),!(a=this.classAppliers[c[3]]))throw new Error("No class applier found for class '"+c[3]+"'");(r=new A(this.doc,r,a,this.converter,parseInt(c[2]),i)).apply(),h.push(r)}this.highlights=h}},y.Highlighter=p,y.createHighlighter=function(e,t){return new p(e,t)}}),e},this);